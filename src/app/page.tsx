'use client';

import { useEffect, useMemo, useState } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import Image from 'next/image';
import { Button, Collapse, Divider, Input, Select, Tag } from 'antd';
import { differenceInDays } from 'date-fns'

import {
  fetchCharacterBasicInfo,
  fetchCharacterBeautyInfo,
  fetchCharacterGuildInfo,
  fetchCharacterId,
  fetchCharacterItemInfo,
  fetchCharacterPetInfo,
  fetchCharacterSkillInfo,
  fetchCharacterStatInfo,
  fetchCharacterVmatrixInfo,
} from '~/lib/queries';
import { formatDate, formatDatetime } from '~/lib/utils';
import { WORLDS } from '~/lib/constants';

import type {
  CharacterBasicInfo,
  CharacterBeautyInfo,
  CharacterPetInfo,
  CharacterSkillInfo,
  CharacterVmatrixInfo,
  ItemEquipment,
  Stat,
  VCoreEquipment,
} from '~/types/queries';

type CharacterInfo = {
  basicInfo: CharacterBasicInfo | null;
  // beautyInfo: CharacterBeautyInfo | null;
  guildName: string;
  itemEquipment: ItemEquipment[];
  petInfo: CharacterPetInfo | null;
  skillInfo: CharacterSkillInfo | null;
  stat: Stat[];
  vmatrixInfo: RefinedVmatrix;
};

type Tag = {
color: string;
label: string;
}

type RefinedVmatrix = {
  enhancement: VCoreEquipment[];
  skill: VCoreEquipment[];
  special: VCoreEquipment[];  
}


export default function Home() {
  const router = useRouter();

  const [form, setForm] = useState({
    characterName: 'ÌôçÏ∞®',
    worldName: 'ÌÅ¨Î°úÏïÑ',
  });
  const [characterInfo, setCharacterInfo] = useState<CharacterInfo>({
    basicInfo: null,
    // beautyInfo: null,
    guildName: '',
    itemEquipment: [],
    petInfo: null,
    skillInfo: null,
    stat: [],
    vmatrixInfo: {
      enhancement: [],
      skill: [],
      special: [],
    },
  });

  const {basicInfo, guildName, itemEquipment, petInfo, skillInfo, stat, vmatrixInfo} = characterInfo


  const tags: Tag[] = useMemo(() => {
    const equip = itemEquipment.reduce((acc, cur) => {
      if (cur.item_name.includes('ÌòàÎßπÏùò Î∞òÏßÄ')) {
        acc.hasHyulBan = true;
      }

      if (cur.item_name.includes('Ïú†ÎãàÏò®Ïùò Í∞ÄÌò∏')) {
        acc.hasGaho = true;
      }

      if (cur.item_name.includes('ÏïÑÏºÄÏù∏ÏÖ∞Ïù¥Îìú')) {
        acc.arcane += 1;
      }

      if (cur.item_name.includes('Ïï±ÏÜîÎû©Ïä§')) {
        acc.absolabs += 1;
      }

      return acc;
    }, {hasHyulBan: false, hasGaho: false, arcane: 0, absolabs: 0})

    const { hasHyulBan, hasGaho, arcane, absolabs } = equip;
    const tags = [
      {color : hasHyulBan ? 'green' : 'red', label: hasHyulBan ? 'ÌòàÎ∞ò ÏûàÏùå': 'ÌòàÎ∞ò ÏóÜÏùå'},
      {color : hasGaho ? 'green' : 'red', label: hasGaho ? 'Í∞ÄÌò∏ ÏûàÏùå' : 'Í∞ÄÌò∏ ÏóÜÏùå'},
      {color: 'cyan', label: `${arcane}Ïïú ${absolabs}Ïï±`},
    ]


    return tags
  }, [itemEquipment])

  const onSearch = async () => {
    try {
      const { ocid } = await fetchCharacterId(form);
      const [
        basicInfo,
        // beautyInfo,
        { guild_name },
        { item_equipment },
        petInfo,
        skillInfo,
        { stat },
        vmatrixInfo,
      ] = await Promise.all([
        fetchCharacterBasicInfo(ocid),
        // fetchCharacterBeautyInfo(ocid),
        fetchCharacterGuildInfo(ocid),
        fetchCharacterItemInfo(ocid),
        fetchCharacterPetInfo(ocid),
        fetchCharacterSkillInfo(ocid),
        fetchCharacterStatInfo(ocid),
        fetchCharacterVmatrixInfo(ocid),
      ]);

      const refinedVmatrix = vmatrixInfo.character_v_core_equipment.reduce<RefinedVmatrix>((acc, cur) => {
        if (cur.v_core_type === 'Enhancement') {
          acc.enhancement.push(cur);
        } else if (cur.v_core_type === 'Skill') {
          acc.skill.push(cur);
        } else if (cur.v_core_type === 'Special') {
          acc.special.push(cur);
        }

        return acc;
      }, {
        enhancement: [],
        skill: [],
        special: [],
      })


      setCharacterInfo({
        basicInfo,
        // beautyInfo,
        guildName: guild_name,
        itemEquipment: item_equipment,
        petInfo,
        skillInfo,
        stat,
        vmatrixInfo: refinedVmatrix,
      });
    } catch (error) {}
  };

  console.log(characterInfo);

  return (
    <main className="flex h-full flex-col p-5 gap-y-4 mx-auto mb-24 w-128 z-50 overflow-y-auto">
      <div className="font-extrabold text-center text-4xl">ü™Ñ Î≥¥Ïó¨Ï°∞ ü™Ñ</div>
      <div className="flex flex-col gap-y-1">
        <label className="font-medium text-lg">ÏõîÎìú</label>
        <Select
          className="w-full"
          defaultValue={WORLDS[0].name}
          fieldNames={{ label: 'name', value: 'name' }}
          options={WORLDS}
          size="large"
          value={form.worldName}
          labelRender={(option) => (
            <div className="flex gap-x-2 items-center">
              <Image
                src={`/logo/${option.value}.png`}
                width={20}
                height={20}
                style={{height: '20px'}}
                alt="ÏõîÎìú Î°úÍ≥†"
              />
              {option.label}
            </div>
          )}
          optionRender={(option) => (
            <div className="flex gap-x-2">
              <Image
                src={`/logo/${option.value}.png`}
                width={20}
                height={20}
                alt="ÏõîÎìú Î°úÎèÑ Ïù¥ÎØ∏ÏßÄ"
              />
              {option.label}
            </div>
          )}
          onSelect={(value) => setForm({ ...form, worldName: value })}
        />
      </div>
      <div className="flex flex-col gap-y-1">
        <label className="font-medium text-lg">ÎãâÎÑ§ÏûÑ</label>
        <Input
          size="large"
          maxLength={20}
          placeholder="Ï∫êÎ¶≠ÌÑ∞ ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!"
          value={form.characterName}
          onChange={({ target }) =>
            setForm({ ...form, characterName: target.value })
          }
        />
      </div>

      {basicInfo && (
        <>
         <Divider className='my-1' />

      <div className='flex flex-wrap gap-x-0.5 gap-y-2'>
        {tags.map((tag, index) => (
          <Tag key={index} color={tag.color} className='text-base'>{tag.label}</Tag>
        ))}
      </div>

      <Collapse
        collapsible="header"
        defaultActiveKey={['1']}
        size="large"
        items={[
          {
            key: '1',
            label: `${basicInfo?.character_name} Í∏∞Î≥∏ Ï†ïÎ≥¥`,
            children: (
              <ul className='list-disc pl-3'>
                <li>ÎãâÎÑ§ÏûÑ: {basicInfo?.character_name}</li>
                <li>ÏõîÎìú: {basicInfo?.world_name}</li>
                <li>ÏßÅÏóÖ: {basicInfo?.character_job_name}</li>
                <li>Î†àÎ≤®: {basicInfo?.character_level}</li>
                <li>Í∏∏Îìú: {guildName || 'X'}</li>
                <li>
                  ÏÉùÎÖÑÏõîÏùº: {formatDate(basicInfo?.character_date_create)}
                </li>
              </ul>
            ),
          },
        ]}
      />

      <Collapse 
        collapsible="header"
        defaultActiveKey={['1']}
        size="large"
        items={[
          {
            key: '1',
            label: 'Ïä§ÌÉØ Ï†ïÎ≥¥',
            children: (
                <ul className='list-disc pl-3'>
                  {stat.map((stat) => (
                    <li>{stat.stat_name}: {Number(stat.stat_value).toLocaleString('ko-KR')}</li>
                  ))}
                </ul>
            ),
                }
        ]}
      />

      <Collapse
        collapsible="header"
        defaultActiveKey={['1']}
        size="large"
        items={[
          {
            key: '1',
            label: 'Ïä§ÌÇ¨ Ï†ïÎ≥¥',
            children: (
              <div className="flex flex-col gap-y-4">
                <div>
                  <label>Ïä§ÌÇ¨ ÌîÑÎ¶¨ÏÖã</label>
                  {characterInfo?.skillInfo?.skill.preset.map((preset) => (
                    <div>
                      <div>ÌîÑÎ¶¨ÏÖã {preset.preset_slot_no}Î≤à</div>
                      <span>{preset.skill_name_1 || 'X'} / </span>
                      <span>{preset.skill_name_2 || 'X'} / </span>
                      <span>{preset.skill_name_3 || 'X'} / </span>
                      <span>{preset.skill_name_4 || 'X'}</span>
                    </div>
                  ))}
                </div>
              </div>
            ),
          },
        ]}
      />

      <Collapse
        collapsible="header"
        defaultActiveKey={['1']}
        size="large"
        items={[
          {
            key: '1',
            label: 'V Îß§Ìä∏Î¶≠Ïä§ Ï†ïÎ≥¥',
            children: (
              <>
              <label>5Ï∞® Ïä§ÌÇ¨</label>
                {vmatrixInfo.skill.map(
                  (core) => (
                    <>
                      <div>
                        {core.v_core_name} ({core.v_core_level}+
                        {core.slot_level})
                      </div>
                      <br />
                    </>
                  )
                )}

                <label>Í∞ïÌôî Ïä§ÌÇ¨</label>
                {vmatrixInfo.enhancement.map(
                  (core) => (
                    <>
                      <div>
                        {core.v_core_name} ({core.v_core_level}+
                        {core.slot_level})
                        {core.v_core_type === 'Enhancement' && (
                          <>
                            <br />
                            {core.v_core_skill_name_1} + {core.v_core_skill_name_2} + {core.v_core_skill_name_3}
                          </>
                        )}
                      </div>
                      <br />
                    </>
                  )
                )}

                <label>ÌäπÏàò Ïä§ÌÇ¨</label>
                {vmatrixInfo.special.map(
                  (core) => (
                    <>
                      <div>
                        {core.v_core_name} ({core.v_core_level}+
                        {core.slot_level})
                      
                      </div>
                      <br />
                    </>
                  )
                )}

              </>
            ),
          },
        ]}
      />

      <Collapse
        collapsible="header"
        defaultActiveKey={['1']}
        size="large"
        items={[
          {
            key: '1',
            label: <div>
              Ìé´ Ï†ïÎ≥¥ (<span className='text-sm'>Ìé´ ÏÉùÎ™ÖÏù¥ <span className='font-bold text-blue-500'>3Ïùº</span> Ïù¥ÌïòÎ°ú ÎÇ®ÏùÄ Í≤ΩÏö∞ ÌÉúÍ∑∏Í∞Ä ÌëúÏãúÎê©ÎãàÎã§</span>)
            </div>,
            children: (
                <ul className='list-disc pl-3'>
                  {petInfo?.pet_1_name && petInfo?.pet_1_date_expire && 
                    <div className='flex gap-x-2'>
                      <li>{petInfo.pet_1_name}</li>
                      {differenceInDays(new Date(petInfo.pet_1_date_expire), new Date()) <= 3 && (
                        <Tag color='red'>ÏÉùÎ™ÖÏùò Î¨º ÌïÑÏöî</Tag>
                      )}
                    </div>
                  }
                  {petInfo?.pet_2_name && petInfo?.pet_2_date_expire && 
                    <div className='flex gap-x-2'>
                      <li>{petInfo.pet_2_name}</li>
                      {differenceInDays(new Date(petInfo.pet_2_date_expire), new Date()) <= 3 && (
                        <Tag color='red'>ÏÉùÎ™ÖÏùò Î¨º ÌïÑÏöî</Tag>
                      )}
                    </div>
                  }
                  {petInfo?.pet_3_name && petInfo?.pet_3_date_expire && 
                    <div className='flex gap-x-2'>
                      <li>{petInfo.pet_3_name}</li>
                      {differenceInDays(new Date(petInfo.pet_3_date_expire), new Date()) <= 3 && (
                        <Tag color='red'>ÏÉùÎ™ÖÏùò Î¨º ÌïÑÏöî</Tag>
                      )}
                    </div>
                  }
                </ul>
            ),
          },
        ]}
      />
        </>
      )}

      {/* <div className="fixed bottom-0 right-0 left-0 w-full bg-white flex justify-center"> */}
        <div className='w-128 p-5 fixed bottom-0 left-1/2 -translate-x-1/2 bg-white'>
          <Button
            className="h-14 text-2xl font-bold w-full"
            size="large"
            type="primary"
            onClick={onSearch}
          >
            Î≥¥Ïó¨Ï°∞!
          </Button>
        </div>
      {/* </div> */}
    </main>
  );
}
